<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare DNS è§£æç®¡ç†å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .api-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .dns-records {
            background: #f8f9fa;
            border-radius: 0 0 8px 8px;
            padding: 0;
        }

        .dns-records.no-header {
            border-radius: 8px;
            padding: 20px;
        }

        .record-item {
            background: white;
            border-radius: 0;
            margin-bottom: 1px;
            border-left: 4px solid #667eea;
            box-shadow: none;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .record-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .record-item:last-child {
            border-radius: 0 0 8px 8px;
            margin-bottom: 0;
        }

        .record-item:only-child {
            border-radius: 8px;
        }

        .record-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .record-item.expanded {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .record-summary {
            padding: 12px 16px;
            display: grid;
            grid-template-columns: 24px 80px 60px 1fr 1fr 80px 80px 120px;
            gap: 12px;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .record-summary:hover {
            background: #f8f9fa;
        }

        .record-details {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
            background: #fafbfc;
            display: none;
        }

        .record-details.expanded {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }



        .record-item.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .record-name-compact {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .record-value-compact {
            color: #666;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .record-ttl-compact {
            color: #888;
            font-size: 12px;
            text-align: center;
        }

        .record-status-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 12px;
            color: #666;
        }

        .expand-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
            color: #666;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .record-actions-compact {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-dot.proxied {
            background: #ff9500;
        }

        .record-actions-compact {
            display: flex;
            gap: 4px;
        }

        .btn-compact {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-compact.btn-edit {
            background: #17a2b8;
            color: white;
        }

        .btn-compact.btn-copy {
            background: #28a745;
            color: white;
        }

        .btn-compact.btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-compact:hover {
            transform: scale(1.05);
        }

        .record-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .detail-value {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .detail-value.monospace {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 4px;
        }

        /* å¢å¤§é€‰æ‹©æ¡† */
        .record-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            transform: scale(1.2);
            margin: 0;
        }

        .record-checkbox:hover {
            transform: scale(1.3);
        }

        .checkbox-container:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .record-type {
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            min-width: 40px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: inline-block;
        }

        .record-type.type-A {
            background: #28a745;
        }

        .record-type.type-AAAA {
            background: #17a2b8;
        }

        .record-type.type-CNAME {
            background: #ffc107;
            color: #333;
        }

        .record-type.type-MX {
            background: #fd7e14;
        }

        .record-type.type-TXT {
            background: #6f42c1;
        }

        .record-type.type-SRV {
            background: #e83e8c;
        }

        .record-type.type-NS {
            background: #6c757d;
        }

        .record-type.type-PTR {
            background: #dc3545;
        }

        .record-type.default {
            background: #667eea;
        }

        .record-name {
            font-weight: 700;
            color: #333;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .record-name-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .record-value {
            color: #555;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 14px;
            word-break: break-all;
            margin-top: 4px;
        }

        .record-value-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .record-ttl {
            color: #888;
            font-size: 12px;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .record-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.proxied {
            background: #ff9500;
        }

        .cdn-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .cdn-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ff9500;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .record-actions {
            display: flex;
            gap: 5px;
        }

        .record-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .batch-textarea {
            min-height: 200px;
            font-family: monospace;
            font-size: 12px;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .zone-selector {
            margin-bottom: 20px;
        }

        .zone-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .zone-item:hover {
            background-color: #f0f0f0;
        }

        .zone-item.selected {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .api-config {
                grid-template-columns: 1fr;
            }
            
            .toolbar {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .record-summary {
                grid-template-columns: 20px 60px 45px 1fr 80px;
                gap: 8px;
                padding: 10px 12px;
            }

            .record-value-compact {
                max-width: 150px;
                font-size: 12px;
            }

            .record-ttl-compact,
            .record-status-compact {
                display: none;
            }

            .record-actions-compact {
                flex-direction: column;
                gap: 2px;
            }

            .record-actions-compact .btn-compact {
                min-width: 24px;
            }

            .btn-compact {
                padding: 6px 8px;
                font-size: 10px;
            }

            .record-details-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .record-name-compact {
                min-width: auto;
                font-size: 13px;
            }

            .record-type {
                padding: 2px 6px;
                font-size: 9px;
                min-width: 35px;
            }

            .record-checkbox {
                transform: scale(1.4);
            }

            .checkbox-container {
                padding: 6px;
            }

            /* æœç´¢æ ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .search-filter-container {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .search-filter-container > div {
                flex-direction: column;
                gap: 8px;
            }
        }

        .search-filter-container {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ Cloudflare DNS è§£æç®¡ç†å·¥å…·</h1>
            <p>ä¸“ä¸šçš„ DNS è®°å½•æ‰¹é‡ç®¡ç†å’Œé…ç½®è¿ç§»å·¥å…·</p>
        </div>

        <!-- CORS é”™è¯¯æç¤ºå¡ç‰‡ -->
        <div class="card" id="corsWarning" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; display: none;">
            <h2>âš ï¸ CORS è·¨åŸŸè®¿é—®é™åˆ¶</h2>
            <p>ç”±äºæµè§ˆå™¨å®‰å…¨ç­–ç•¥ï¼Œæ— æ³•ç›´æ¥è®¿é—® Cloudflare APIã€‚è¯·é€‰æ‹©ä»¥ä¸‹è§£å†³æ–¹æ¡ˆä¹‹ä¸€ï¼š</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0;">
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h3>ğŸ”§ æ–¹æ¡ˆä¸€ï¼šç¦ç”¨æµè§ˆå™¨ CORS æ£€æŸ¥</h3>
                    <p style="font-size: 14px; margin: 10px 0;">å¯åŠ¨ Chrome æ—¶æ·»åŠ å‚æ•°ï¼ˆä»…ç”¨äºå¼€å‘æµ‹è¯•ï¼‰ï¼š</p>
                    <code style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; display: block; font-size: 12px;">
                        chrome.exe --disable-web-security --user-data-dir="C:\temp\chrome_dev"
                    </code>
                    <button class="btn" style="background: rgba(255,255,255,0.2); margin-top: 10px;" onclick="copyToClipboard('chrome.exe --disable-web-security --user-data-dir=&quot;C:\\temp\\chrome_dev&quot;')">å¤åˆ¶å‘½ä»¤</button>
                </div>
                
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h3>ğŸŒ æ–¹æ¡ˆäºŒï¼šä½¿ç”¨æµè§ˆå™¨æ‰©å±•</h3>
                    <p style="font-size: 14px; margin: 10px 0;">å®‰è£… CORS è§£é™¤æ‰©å±•ï¼š</p>
                    <ul style="font-size: 14px; margin: 10px 0;">
                        <li><a href="https://chrome.google.com/webstore/detail/cors-unblock/lfhmikememgdcahcdlaciloancbhjino" target="_blank" style="color: #fff; text-decoration: underline;">CORS Unblock</a></li>
                        <li><a href="https://chrome.google.com/webstore/detail/moesif-origin-cors-change/digfbfaphojjndkpccljibejjbppifbc" target="_blank" style="color: #fff; text-decoration: underline;">Moesif CORS</a></li>
                    </ul>
                </div>
                
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h3>ğŸ–¥ï¸ æ–¹æ¡ˆä¸‰ï¼šæœ¬åœ°ä»£ç†æœåŠ¡å™¨</h3>
                    <p style="font-size: 14px; margin: 10px 0;">å¯åŠ¨å†…ç½®ä»£ç†æœåŠ¡å™¨ï¼š</p>
                    <button class="btn" style="background: rgba(255,255,255,0.2);" onclick="startProxyServer()">å¯åŠ¨ä»£ç†æœåŠ¡å™¨</button>
                    <div id="proxyServerStatus" style="margin-top: 10px; font-size: 12px;"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" style="background: rgba(255,255,255,0.2);" onclick="hideCorsWarning()">æˆ‘å·²è§£å†³ CORS é—®é¢˜</button>
                <button class="btn" style="background: rgba(255,255,255,0.2);" onclick="testCorsFixed()">é‡æ–°æµ‹è¯•è¿æ¥</button>
            </div>
        </div>

        <!-- API é…ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>ğŸ”‘ API é…ç½®</h2>
            <div class="api-config">
                <div class="form-group">
                    <label for="apiToken">Cloudflare API Token</label>
                    <input type="password" id="apiToken" placeholder="è¾“å…¥æ‚¨çš„ Cloudflare API Token">
                    <small style="color: #666; margin-top: 5px;">
                        éœ€è¦ Zone:Read å’Œ DNS:Edit æƒé™
                    </small>
                </div>
                <div class="form-group">
                    <label for="email">Cloudflare è´¦æˆ·é‚®ç®±</label>
                    <input type="email" id="email" placeholder="è¾“å…¥æ‚¨çš„ Cloudflare è´¦æˆ·é‚®ç®±">
                </div>
            </div>
            
            <!-- ä»£ç†æ¨¡å¼è®¾ç½® -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="margin: 0 0 10px 0; color: #555;">ğŸ”§ è¿æ¥æ¨¡å¼</h4>
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="connectionMode" value="direct" id="directMode" onchange="switchConnectionMode()" checked>
                        <span>ç›´æ¥è¿æ¥ (å¯èƒ½é‡åˆ° CORS é—®é¢˜)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="connectionMode" value="proxy" id="proxyMode" onchange="switchConnectionMode()">
                        <span>ä»£ç†æ¨¡å¼ (æ¨è)</span>
                    </label>
                    <input type="text" id="proxyUrl" placeholder="ä»£ç†æœåŠ¡å™¨åœ°å€" value="http://localhost:3001/api" 
                           style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 200px; display: none;"
                           onchange="localStorage.setItem('cf_dns_proxy_url', this.value)">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="loadZones()">
                    <span class="loading-text">è¿æ¥å¹¶åŠ è½½åŸŸå</span>
                </button>
                <button class="btn btn-info" onclick="showProxyModal()">ğŸŒ ä»£ç†è®¾ç½®</button>
                <button class="btn btn-warning" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
                <button class="btn btn-success" onclick="testStatusDisplay()" style="font-size: 12px;">ğŸ§ª æµ‹è¯•çŠ¶æ€æ˜¾ç¤º</button>
            </div>
        </div>

        <!-- åŸŸåé€‰æ‹©å¡ç‰‡ -->
        <div class="card" id="zoneCard" style="display: none;">
            <h2>ğŸ·ï¸ åŸŸåé€‰æ‹©</h2>
            <div class="zone-selector" id="zoneSelector">
                <!-- åŸŸååˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
            <div class="stats-grid" id="statsGrid">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- DNS è®°å½•ç®¡ç†å¡ç‰‡ -->
        <div class="card" id="recordsCard" style="display: none;">
            <h2>ğŸ“‹ DNS è®°å½•ç®¡ç†</h2>
            
            <!-- æœç´¢å’Œç­›é€‰æ  -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div class="search-filter-container">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="searchRecords" placeholder="ğŸ” æœç´¢è®°å½•åç§°æˆ–å€¼..." 
                               style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                               oninput="filterRecords()">
                        <select id="typeFilter" onchange="filterRecords()" 
                                style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">æ‰€æœ‰ç±»å‹</option>
                            <option value="A">A è®°å½•</option>
                            <option value="AAAA">AAAA è®°å½•</option>
                            <option value="CNAME">CNAME è®°å½•</option>
                            <option value="MX">MX è®°å½•</option>
                            <option value="TXT">TXT è®°å½•</option>
                            <option value="SRV">SRV è®°å½•</option>
                            <option value="NS">NS è®°å½•</option>
                            <option value="PTR">PTR è®°å½•</option>
                        </select>
                    </div>
                    <select id="proxyFilter" onchange="filterRecords()" 
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="">CDN çŠ¶æ€</option>
                        <option value="true">å·²å¯ç”¨ CDN</option>
                        <option value="false">æœªå¯ç”¨ CDN</option>
                    </select>
                    <button class="btn btn-info" onclick="clearFilters()" style="white-space: nowrap;">æ¸…é™¤ç­›é€‰</button>
                </div>
            </div>

            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <button class="btn btn-success" onclick="showAddRecordModal()">â• æ·»åŠ è®°å½•</button>
                <button class="btn btn-info" onclick="showBatchAddModal()">ğŸ“¦ æ‰¹é‡æ·»åŠ </button>
                <button class="btn btn-warning" onclick="showBatchOperationModal()">âš¡ æ‰¹é‡æ“ä½œ</button>
                <button class="btn btn-primary" onclick="exportConfig()">ğŸ“¤ å¯¼å‡ºé…ç½®</button>
                <button class="btn btn-primary" onclick="showImportModal()">ğŸ“¥ å¯¼å…¥é…ç½®</button>
                <button class="btn" onclick="expandAllRecords()" style="background: #6c757d; color: white;">ğŸ“– å±•å¼€å…¨éƒ¨</button>
                <button class="btn" onclick="collapseAllRecords()" style="background: #6c757d; color: white;">ğŸ“• æ”¶èµ·å…¨éƒ¨</button>
                <button class="btn btn-danger" onclick="refreshRecords()">ğŸ”„ åˆ·æ–°è®°å½•</button>
            </div>

            <!-- çŠ¶æ€æ¶ˆæ¯ -->
            <div id="statusMessage" style="display: none;"></div>

            <!-- è®°å½•åˆ—è¡¨è¡¨å¤´ -->
            <div style="background: #f8f9fa; border-radius: 8px 8px 0 0; padding: 8px 16px; margin-bottom: 0; border-bottom: 1px solid #dee2e6; display: none;" id="recordsHeader">
                <div style="display: grid; grid-template-columns: 24px 80px 60px 1fr 1fr 80px 80px 120px; gap: 12px; align-items: center; font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">
                    <div style="text-align: center;">å±•å¼€</div>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="checkbox" id="selectAllRecords" onchange="toggleSelectAll()" style="transform: scale(1.1);">
                        <span>é€‰æ‹©</span>
                    </div>
                    <div style="text-align: center;">ç±»å‹</div>
                    <div>åç§°</div>
                    <div>å€¼</div>
                    <div style="text-align: center;">TTL</div>
                    <div style="text-align: center;">çŠ¶æ€</div>
                    <div style="text-align: center;">æ“ä½œ</div>
                </div>
            </div>

            <!-- DNS è®°å½•åˆ—è¡¨ -->
            <div class="dns-records" id="recordsList">
                <!-- DNS è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ  DNS è®°å½•</h2>
                <span class="close" onclick="closeModal('recordModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="recordType">è®°å½•ç±»å‹</label>
                <select id="recordType">
                    <option value="A">A - IPv4 åœ°å€</option>
                    <option value="AAAA">AAAA - IPv6 åœ°å€</option>
                    <option value="CNAME">CNAME - åˆ«å</option>
                    <option value="MX">MX - é‚®ä»¶äº¤æ¢</option>
                    <option value="TXT">TXT - æ–‡æœ¬è®°å½•</option>
                    <option value="SRV">SRV - æœåŠ¡è®°å½•</option>
                    <option value="NS">NS - åŸŸåæœåŠ¡å™¨</option>
                    <option value="PTR">PTR - æŒ‡é’ˆè®°å½•</option>
                </select>
            </div>
            <div class="form-group">
                <label for="recordName">è®°å½•åç§°</label>
                <input type="text" id="recordName" placeholder="ä¾‹å¦‚ï¼šwww æˆ– @ (æ ¹åŸŸå)">
            </div>
            <div class="form-group">
                <label for="recordValue">è®°å½•å€¼</label>
                <input type="text" id="recordValue" placeholder="ä¾‹å¦‚ï¼š192.168.1.1 æˆ– example.com">
            </div>
            <div class="form-group">
                <label for="recordTTL">TTL (ç§’)</label>
                <select id="recordTTL">
                    <option value="1">è‡ªåŠ¨</option>
                    <option value="120">2 åˆ†é’Ÿ</option>
                    <option value="300">5 åˆ†é’Ÿ</option>
                    <option value="600">10 åˆ†é’Ÿ</option>
                    <option value="1800">30 åˆ†é’Ÿ</option>
                    <option value="3600">1 å°æ—¶</option>
                    <option value="7200">2 å°æ—¶</option>
                    <option value="18000">5 å°æ—¶</option>
                    <option value="43200">12 å°æ—¶</option>
                    <option value="86400">1 å¤©</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="recordProxied"> å¯ç”¨ Cloudflare ä»£ç† (CDN)
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveRecord()">ä¿å­˜è®°å½•</button>
                <button class="btn" onclick="closeModal('recordModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ·»åŠ æ¨¡æ€æ¡† -->
    <div id="batchAddModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ‰¹é‡æ·»åŠ  DNS è®°å½•</h2>
                <span class="close" onclick="closeModal('batchAddModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="batchRecords">æ‰¹é‡è®°å½• (æ¯è¡Œä¸€æ¡è®°å½•ï¼Œæ ¼å¼ï¼šç±»å‹,åç§°,å€¼,TTL,æ˜¯å¦ä»£ç†)</label>
                <textarea id="batchRecords" class="batch-textarea" placeholder="ç¤ºä¾‹ï¼š&#10;A,www,192.168.1.1,3600,true&#10;CNAME,mail,mail.example.com,3600,false&#10;TXT,@,&quot;v=spf1 include:_spf.google.com ~all&quot;,3600,false"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="batchAddRecords()">æ‰¹é‡æ·»åŠ </button>
                <button class="btn" onclick="closeModal('batchAddModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œæ¨¡æ€æ¡† -->
    <div id="batchOperationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ‰¹é‡æ“ä½œ</h2>
                <span class="close" onclick="closeModal('batchOperationModal')">&times;</span>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-warning" onclick="batchToggleCDN(true)">æ‰¹é‡å¼€å¯ CDN</button>
                <button class="btn btn-warning" onclick="batchToggleCDN(false)">æ‰¹é‡å…³é—­ CDN</button>
                <button class="btn btn-danger" onclick="batchDeleteRecords()">æ‰¹é‡åˆ é™¤é€‰ä¸­è®°å½•</button>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="selectAllRecordsModal" onchange="toggleSelectAllInModal()"> å…¨é€‰è®°å½•
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="closeModal('batchOperationModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥é…ç½®æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å¯¼å…¥é…ç½®</h2>
                <span class="close" onclick="closeModal('importModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="importFile">é€‰æ‹©é…ç½®æ–‡ä»¶ (.json)</label>
                <input type="file" id="importFile" accept=".json">
            </div>
            <div class="form-group">
                <label for="targetZone">ç›®æ ‡åŸŸå</label>
                <select id="targetZone">
                    <!-- åŸŸåé€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="replaceExisting"> æ›¿æ¢ç°æœ‰è®°å½•ï¼ˆè°¨æ…æ“ä½œï¼ï¼‰
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="importConfig()">å¼€å§‹å¯¼å…¥</button>
                <button class="btn" onclick="closeModal('importModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä»£ç†è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="proxyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸŒ ç½‘ç»œä»£ç†è®¾ç½®</h2>
                <span class="close" onclick="closeModal('proxyModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="enableProxy" onchange="toggleProxySettings()"> å¯ç”¨ç½‘ç»œä»£ç†
                </label>
            </div>
            <div id="proxySettings" style="display: none;">
                <div class="form-group">
                    <label for="proxyType">ä»£ç†ç±»å‹</label>
                    <select id="proxyType">
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="socks5">SOCKS5</option>
                    </select>
                </div>
                <div class="api-config">
                    <div class="form-group">
                        <label for="proxyHost">ä»£ç†æœåŠ¡å™¨</label>
                        <input type="text" id="proxyHost" placeholder="ä¾‹å¦‚ï¼š127.0.0.1">
                    </div>
                    <div class="form-group">
                        <label for="proxyPort">ç«¯å£</label>
                        <input type="number" id="proxyPort" placeholder="ä¾‹å¦‚ï¼š7890">
                    </div>
                </div>
                <div class="api-config">
                    <div class="form-group">
                        <label for="proxyUsername">ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="proxyUsername" placeholder="ä»£ç†ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label for="proxyPassword">å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="password" id="proxyPassword" placeholder="ä»£ç†å¯†ç ">
                    </div>
                </div>
                <div class="form-group">
                    <button class="btn btn-info" onclick="testProxyConnection()">æµ‹è¯•ä»£ç†è¿æ¥</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveProxySettings()">ä¿å­˜è®¾ç½®</button>
                <button class="btn" onclick="closeModal('proxyModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- é”™è¯¯è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âŒ é”™è¯¯è¯¦æƒ…</h2>
                <span class="close" onclick="closeModal('errorModal')">&times;</span>
            </div>
            <div id="errorDetails" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">
                <!-- é”™è¯¯è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-info" onclick="copyErrorDetails()">å¤åˆ¶é”™è¯¯ä¿¡æ¯</button>
                <button class="btn" onclick="closeModal('errorModal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentZoneId = null;
        let currentZoneName = null;
        let allRecords = [];
        let filteredRecords = [];
        let editingRecordId = null;
        let lastSelectedIndex = -1; // ç”¨äº Shift æ‰¹é‡é€‰æ‹©
        let proxySettings = {
            enabled: false,
            type: 'http',
            host: '',
            port: '',
            username: '',
            password: ''
        };

        // å¸¸è§é”™è¯¯ç å’Œè§£å†³æ–¹æ¡ˆ
        const ERROR_SOLUTIONS = {
            10000: {
                title: 'API Token æ— æ•ˆ',
                message: 'API Token æ ¼å¼é”™è¯¯æˆ–å·²è¿‡æœŸ',
                solutions: [
                    'æ£€æŸ¥ API Token æ˜¯å¦æ­£ç¡®å¤åˆ¶',
                    'ç¡®è®¤ Token æœªè¿‡æœŸ',
                    'é‡æ–°ç”Ÿæˆæ–°çš„ API Token'
                ]
            },
            10001: {
                title: 'è®¤è¯å¤±è´¥',
                message: 'é‚®ç®±æˆ– API Token ä¸åŒ¹é…',
                solutions: [
                    'ç¡®è®¤é‚®ç®±åœ°å€æ­£ç¡®',
                    'æ£€æŸ¥ API Token æ˜¯å¦å±äºè¯¥é‚®ç®±è´¦æˆ·',
                    'å°è¯•ä½¿ç”¨ Global API Key æ›¿ä»£ Token'
                ]
            },
            10002: {
                title: 'æƒé™ä¸è¶³',
                message: 'API Token æƒé™ä¸è¶³',
                solutions: [
                    'ç¡®ä¿ Token å…·æœ‰ Zone:Read æƒé™',
                    'ç¡®ä¿ Token å…·æœ‰ DNS:Edit æƒé™',
                    'æ£€æŸ¥ Token çš„åŸŸåèŒƒå›´è®¾ç½®'
                ]
            },
            10004: {
                title: 'è¯·æ±‚é¢‘ç‡é™åˆ¶',
                message: 'API è¯·æ±‚è¿‡äºé¢‘ç¹',
                solutions: [
                    'ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•',
                    'å‡å°‘æ‰¹é‡æ“ä½œçš„å¹¶å‘æ•°é‡',
                    'å‡çº§ Cloudflare å¥—é¤è·å¾—æ›´é«˜é™åˆ¶'
                ]
            },
            10006: {
                title: 'ç½‘ç»œè¿æ¥é”™è¯¯',
                message: 'æ— æ³•è¿æ¥åˆ° Cloudflare API',
                solutions: [
                    'æ£€æŸ¥ç½‘ç»œè¿æ¥',
                    'å°è¯•é…ç½®ç½‘ç»œä»£ç†',
                    'æ£€æŸ¥é˜²ç«å¢™è®¾ç½®',
                    'ç¡®è®¤ DNS è§£ææ­£å¸¸'
                ]
            },
            81044: {
                title: 'DNS è®°å½•å†²çª',
                message: 'è®°å½•å·²å­˜åœ¨æˆ–ä¸ç°æœ‰è®°å½•å†²çª',
                solutions: [
                    'æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è®°å½•',
                    'ä½¿ç”¨ä¸åŒçš„è®°å½•åç§°',
                    'å…ˆåˆ é™¤å†²çªçš„è®°å½•'
                ]
            },
            81053: {
                title: 'è®°å½•å€¼æ— æ•ˆ',
                message: 'DNS è®°å½•å€¼æ ¼å¼ä¸æ­£ç¡®',
                solutions: [
                    'æ£€æŸ¥ IP åœ°å€æ ¼å¼ï¼ˆA/AAAA è®°å½•ï¼‰',
                    'æ£€æŸ¥åŸŸåæ ¼å¼ï¼ˆCNAME è®°å½•ï¼‰',
                    'ç¡®è®¤ TXT è®°å½•æ ¼å¼æ­£ç¡®'
                ]
            },
            81057: {
                title: 'è®°å½•åç§°æ— æ•ˆ',
                message: 'DNS è®°å½•åç§°æ ¼å¼ä¸æ­£ç¡®',
                solutions: [
                    'è®°å½•åç§°ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦',
                    'ä½¿ç”¨ @ è¡¨ç¤ºæ ¹åŸŸå',
                    'å­åŸŸåæ ¼å¼ï¼šsubdomain'
                ]
            }
        };

        // åŠ è½½ä»£ç†è®¾ç½®
        function loadProxySettings() {
            const saved = localStorage.getItem('cf_dns_proxy_settings');
            if (saved) {
                proxySettings = JSON.parse(saved);
            }
        }

        // ä¿å­˜ä»£ç†è®¾ç½®
        function saveProxySettingsToStorage() {
            localStorage.setItem('cf_dns_proxy_settings', JSON.stringify(proxySettings));
        }

        // è·å– API åŸºç¡€ URL
        function getApiBaseUrl() {
            const useProxy = localStorage.getItem('cf_dns_use_proxy') === 'true';
            if (useProxy) {
                const proxyUrl = localStorage.getItem('cf_dns_proxy_url') || 'http://localhost:3001/api';
                return proxyUrl;
            }
            return 'https://api.cloudflare.com/client/v4';
        }

        // API è¯·æ±‚å‡½æ•°ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰
        async function makeCloudflareRequest(endpoint, method = 'GET', data = null) {
            const apiToken = document.getElementById('apiToken').value;
            const email = document.getElementById('email').value;
            
            if (!apiToken || !email) {
                throw new Error('è¯·å…ˆé…ç½® API Token å’Œé‚®ç®±');
            }

            const headers = {
                'X-Auth-Email': email,
                'X-Auth-Key': apiToken,
                'Content-Type': 'application/json'
            };

            const config = {
                method: method,
                headers: headers,
                timeout: 30000 // 30ç§’è¶…æ—¶
            };

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                const apiUrl = `${getApiBaseUrl()}${endpoint}`;
                console.log('è¯·æ±‚ URL:', apiUrl);
                const response = await fetch(apiUrl, config);
                
                if (!response.ok) {
                    if (response.status === 0 || response.status >= 500) {
                        throw new Error(`ç½‘ç»œè¿æ¥é”™è¯¯ (${response.status}): æ— æ³•è¿æ¥åˆ° Cloudflare APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å°è¯•é…ç½®ä»£ç†`);
                    } else if (response.status === 403) {
                        throw new Error('API Token æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥ Token æƒé™è®¾ç½®');
                    } else if (response.status === 401) {
                        throw new Error('è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Token å’Œé‚®ç®±æ˜¯å¦æ­£ç¡®');
                    } else if (response.status === 429) {
                        throw new Error('è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•');
                    }
                }

                const result = await response.json();

                if (!result.success) {
                    const error = result.errors?.[0];
                    if (error) {
                        const errorCode = error.code;
                        const errorInfo = ERROR_SOLUTIONS[errorCode];
                        
                        if (errorInfo) {
                            showDetailedError(errorInfo, error, result);
                            throw new Error(`${errorInfo.title}: ${errorInfo.message}`);
                        } else {
                            showDetailedError({
                                title: 'æœªçŸ¥é”™è¯¯',
                                message: error.message || 'è¯·æ±‚å¤±è´¥',
                                solutions: ['è¯·æ£€æŸ¥è¾“å…¥å‚æ•°', 'ç¨åé‡è¯•', 'è”ç³»æŠ€æœ¯æ”¯æŒ']
                            }, error, result);
                            throw new Error(error.message || 'è¯·æ±‚å¤±è´¥');
                        }
                    } else {
                        throw new Error('è¯·æ±‚å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯');
                    }
                }

                return result;
            } catch (error) {
                if (error.name === 'TypeError' && (error.message.includes('fetch') || error.message.includes('CORS'))) {
                    // æ£€æµ‹åˆ° CORS é”™è¯¯ï¼Œæ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
                    showCorsWarning();
                    throw new Error('CORS è·¨åŸŸè®¿é—®è¢«é˜»æ­¢ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„è§£å†³æ–¹æ¡ˆ');
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showCorsWarning();
                    throw new Error('ç½‘ç»œè¯·æ±‚è¢«é˜»æ­¢ï¼Œå¯èƒ½æ˜¯ CORS é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹çš„è§£å†³æ–¹æ¡ˆ');
                }
                throw error;
            }
        }

        // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
        function showDetailedError(errorInfo, originalError, fullResponse) {
            const errorDetails = document.getElementById('errorDetails');
            let errorText = `é”™è¯¯ç±»å‹: ${errorInfo.title}\n`;
            errorText += `é”™è¯¯æè¿°: ${errorInfo.message}\n\n`;
            
            if (originalError.code) {
                errorText += `é”™è¯¯ä»£ç : ${originalError.code}\n`;
            }
            
            errorText += `\nè§£å†³æ–¹æ¡ˆ:\n`;
            errorInfo.solutions.forEach((solution, index) => {
                errorText += `${index + 1}. ${solution}\n`;
            });
            
            if (fullResponse) {
                errorText += `\nå®Œæ•´å“åº”:\n${JSON.stringify(fullResponse, null, 2)}`;
            }
            
            errorDetails.textContent = errorText;
            document.getElementById('errorModal').style.display = 'block';
        }

        // å¤åˆ¶é”™è¯¯è¯¦æƒ…
        function copyErrorDetails() {
            const errorDetails = document.getElementById('errorDetails').textContent;
            navigator.clipboard.writeText(errorDetails).then(() => {
                showStatus('é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯ï¼ˆå¢å¼ºç‰ˆï¼‰
        function showStatus(message, type = 'info', showErrorButton = false) {
            console.log('showStatus è¢«è°ƒç”¨:', message, type);
            
            const statusElement = document.getElementById('statusMessage');
            if (!statusElement) {
                console.error('æ‰¾ä¸åˆ° statusMessage å…ƒç´ ');
                alert(message); // å¤‡ç”¨æ˜¾ç¤ºæ–¹æ³•
                return;
            }
            
            statusElement.className = `status-message status-${type}`;
            
            let statusContent = message;
            if (showErrorButton && type === 'error') {
                statusContent += ' <button class="btn btn-info" onclick="document.getElementById(\'errorModal\').style.display=\'block\'" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">æŸ¥çœ‹è¯¦æƒ…</button>';
            }
            
            statusElement.innerHTML = statusContent;
            statusElement.style.display = 'block';
            
            console.log('çŠ¶æ€æ¶ˆæ¯å·²æ˜¾ç¤º');
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, showErrorButton ? 10000 : 5000);
        }

        // åŠ è½½åŸŸååˆ—è¡¨
        async function loadZones() {
            console.log('loadZones å‡½æ•°è¢«è°ƒç”¨');
            
            // æ‰¾åˆ°æ­£ç¡®çš„æŒ‰é’®
            const button = event ? event.target : document.querySelector('.btn-primary');
            if (!button) {
                console.error('æ‰¾ä¸åˆ°æŒ‰é’®');
                showStatus('ç³»ç»Ÿé”™è¯¯ï¼šæ‰¾ä¸åˆ°æŒ‰é’®å…ƒç´ ', 'error');
                return;
            }
            
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span> åŠ è½½ä¸­...';
            button.disabled = true;

            try {
                const result = await makeCloudflareRequest('/zones');
                const zones = result.result;

                const zoneSelector = document.getElementById('zoneSelector');
                zoneSelector.innerHTML = '';

                zones.forEach(zone => {
                    const zoneItem = document.createElement('div');
                    zoneItem.className = 'zone-item';
                    zoneItem.innerHTML = `
                        <strong>${zone.name}</strong>
                        <br>
                        <small>çŠ¶æ€: ${zone.status} | ç±»å‹: ${zone.type}</small>
                    `;
                    zoneItem.onclick = () => selectZone(zone.id, zone.name);
                    zoneSelector.appendChild(zoneItem);
                });

                document.getElementById('zoneCard').style.display = 'block';
                showStatus(`æˆåŠŸåŠ è½½ ${zones.length} ä¸ªåŸŸå`, 'success');

            } catch (error) {
                showStatus(`åŠ è½½å¤±è´¥: ${error.message}`, 'error', true);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // é€‰æ‹©åŸŸå
        async function selectZone(zoneId, zoneName) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.zone-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.zone-item').classList.add('selected');

            currentZoneId = zoneId;
            currentZoneName = zoneName;

            // æ˜¾ç¤ºè®°å½•ç®¡ç†å¡ç‰‡
            document.getElementById('recordsCard').style.display = 'block';

            // åŠ è½½ DNS è®°å½•
            await loadDNSRecords();

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();

            showStatus(`å·²é€‰æ‹©åŸŸå: ${zoneName}`, 'success');
        }

        // åŠ è½½ DNS è®°å½•
        async function loadDNSRecords() {
            if (!currentZoneId) return;

            try {
                const result = await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records`);
                allRecords = result.result;
                renderDNSRecords();
                updateStats();
            } catch (error) {
                showStatus(`åŠ è½½ DNS è®°å½•å¤±è´¥: ${error.message}`, 'error', true);
            }
        }

        // æ¸²æŸ“ DNS è®°å½•
        function renderDNSRecords() {
            const recordsList = document.getElementById('recordsList');
            const recordsHeader = document.getElementById('recordsHeader');
            recordsList.innerHTML = '';

            const recordsToRender = filteredRecords.length > 0 ? filteredRecords : allRecords;
            
            if (allRecords.length === 0) {
                recordsHeader.style.display = 'none';
                recordsList.className = 'dns-records no-header';
                recordsList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</div>
                        <h3 style="margin-bottom: 10px; color: #888;">æš‚æ—  DNS è®°å½•</h3>
                        <p>ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ è®°å½•"æŒ‰é’®å¼€å§‹æ·»åŠ  DNS è®°å½•</p>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºè¡¨å¤´å¹¶è®¾ç½®åˆ—è¡¨æ ·å¼
            recordsHeader.style.display = 'block';
            recordsList.className = 'dns-records';

            if (filteredRecords.length === 0 && (
                document.getElementById('searchRecords').value ||
                document.getElementById('typeFilter').value ||
                document.getElementById('proxyFilter').value
            )) {
                recordsList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”</div>
                        <h3 style="margin-bottom: 10px; color: #888;">æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•</h3>
                        <p>å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶æˆ–<button class="btn btn-info" onclick="clearFilters()" style="margin-left: 5px;">æ¸…é™¤ç­›é€‰</button></p>
                    </div>
                `;
                return;
            }

            recordsToRender.forEach(record => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                recordItem.dataset.recordId = record.id;
                
                // å¤„ç†è®°å½•åç§°æ˜¾ç¤º
                const displayName = record.name.replace(`.${currentZoneName}`, '') || '@';
                
                recordItem.innerHTML = `
                    <div class="record-summary" onclick="toggleRecordDetails('${record.id}')">
                        <div class="expand-icon">â–¶</div>
                        <div class="checkbox-container" onclick="event.stopPropagation()">
                            <input type="checkbox" class="record-checkbox" data-record-id="${record.id}" 
                                   data-record-index="${recordsToRender.indexOf(record)}"
                                   onchange="handleCheckboxChange(event, ${recordsToRender.indexOf(record)})">
                        </div>
                        <span class="record-type type-${record.type}">${record.type}</span>
                        <div class="record-name-compact">${displayName}</div>
                        <div class="record-value-compact" title="${record.content}">${record.content}</div>
                        <div class="record-ttl-compact">${record.ttl === 1 ? 'è‡ªåŠ¨' : record.ttl + 's'}</div>
                        <div class="record-status-compact">
                            <div class="status-dot ${record.proxied ? 'proxied' : ''}"></div>
                            <span>${record.proxied ? 'CDN' : 'DNS'}</span>
                        </div>
                        <div class="record-actions-compact" onclick="event.stopPropagation()">
                            <button class="btn-compact btn-edit" onclick="editRecord('${record.id}')" title="ç¼–è¾‘">âœï¸</button>
                            <button class="btn-compact btn-copy" onclick="copyRecord('${record.id}')" title="å¤åˆ¶">ğŸ“‹</button>
                            <button class="btn-compact btn-delete" onclick="deleteRecord('${record.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    
                    <div class="record-details" id="details-${record.id}">
                        <div class="record-details-grid">
                            <div class="detail-item">
                                <div class="detail-label">å®Œæ•´åŸŸå</div>
                                <div class="detail-value">${record.name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">è®°å½•å€¼</div>
                                <div class="detail-value monospace">${record.content}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">TTL</div>
                                <div class="detail-value">${record.ttl === 1 ? 'è‡ªåŠ¨' : record.ttl + ' ç§’'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">è®°å½• ID</div>
                                <div class="detail-value monospace">${record.id}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">åˆ›å»ºæ—¶é—´</div>
                                <div class="detail-value">${record.created_on ? new Date(record.created_on).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">ä¿®æ”¹æ—¶é—´</div>
                                <div class="detail-value">${record.modified_on ? new Date(record.modified_on).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #e9ecef;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="cdn-toggle">
                                    <input type="checkbox" id="cdn-${record.id}" ${record.proxied ? 'checked' : ''} 
                                           onchange="toggleCDN('${record.id}', this.checked)">
                                    <label class="slider" for="cdn-${record.id}"></label>
                                </div>
                                <span style="font-size: 14px; color: #666;">
                                    ${record.proxied ? 'ğŸŸ  Cloudflare CDN å·²å¯ç”¨' : 'ğŸŸ¢ ä»… DNS è§£æ'}
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-info" onclick="editRecord('${record.id}')">âœï¸ ç¼–è¾‘è®°å½•</button>
                                <button class="btn btn-success" onclick="copyRecord('${record.id}')">ğŸ“‹ å¤åˆ¶è®°å½•</button>
                                <button class="btn btn-danger" onclick="deleteRecord('${record.id}')">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
                            </div>
                        </div>
                    </div>
                `;
                recordsList.appendChild(recordItem);
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const stats = {
                total: allRecords.length,
                proxied: allRecords.filter(r => r.proxied).length,
                types: {}
            };

            allRecords.forEach(record => {
                stats.types[record.type] = (stats.types[record.type] || 0) + 1;
            });

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">æ€»è®°å½•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.proxied}</div>
                    <div class="stat-label">CDN å¯ç”¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(stats.types).length}</div>
                    <div class="stat-label">è®°å½•ç±»å‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.types.A || 0}</div>
                    <div class="stat-label">A è®°å½•</div>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ·»åŠ è®°å½•æ¨¡æ€æ¡†
        function showAddRecordModal() {
            editingRecordId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ  DNS è®°å½•';
            clearRecordForm();
            document.getElementById('recordModal').style.display = 'block';
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            editingRecordId = recordId;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘ DNS è®°å½•';
            
            document.getElementById('recordType').value = record.type;
            document.getElementById('recordName').value = record.name.replace(`.${currentZoneName}`, '') || '@';
            document.getElementById('recordValue').value = record.content;
            document.getElementById('recordTTL').value = record.ttl;
            document.getElementById('recordProxied').checked = record.proxied;
            
            document.getElementById('recordModal').style.display = 'block';
        }

        // ä¿å­˜è®°å½•
        async function saveRecord() {
            const type = document.getElementById('recordType').value;
            const name = document.getElementById('recordName').value;
            const content = document.getElementById('recordValue').value;
            const ttl = parseInt(document.getElementById('recordTTL').value);
            const proxied = document.getElementById('recordProxied').checked;

            if (!name || !content) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„è®°å½•ä¿¡æ¯', 'error');
                return;
            }

            const recordData = {
                type: type,
                name: name === '@' ? currentZoneName : name,
                content: content,
                ttl: ttl,
                proxied: proxied
            };

            try {
                if (editingRecordId) {
                    // æ›´æ–°è®°å½•
                    await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records/${editingRecordId}`, 'PUT', recordData);
                    showStatus('è®°å½•æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    // åˆ›å»ºè®°å½•
                    await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records`, 'POST', recordData);
                    showStatus('è®°å½•æ·»åŠ æˆåŠŸ', 'success');
                }

                closeModal('recordModal');
                await loadDNSRecords();
            } catch (error) {
                showStatus(`æ“ä½œå¤±è´¥: ${error.message}`, 'error', true);
            }
        }

        // åˆ é™¤è®°å½•
        async function deleteRecord(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ DNS è®°å½•å—ï¼Ÿ')) return;

            try {
                await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records/${recordId}`, 'DELETE');
                showStatus('è®°å½•åˆ é™¤æˆåŠŸ', 'success');
                await loadDNSRecords();
            } catch (error) {
                showStatus(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error', true);
            }
        }

        // åˆ‡æ¢ CDN çŠ¶æ€
        async function toggleCDN(recordId, enabled) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) return;

            const recordData = {
                type: record.type,
                name: record.name,
                content: record.content,
                ttl: record.ttl,
                proxied: enabled
            };

            try {
                await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records/${recordId}`, 'PUT', recordData);
                showStatus(`CDN ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}æˆåŠŸ`, 'success');
                await loadDNSRecords();
            } catch (error) {
                showStatus(`CDN åˆ‡æ¢å¤±è´¥: ${error.message}`, 'error', true);
                // æ¢å¤å¤é€‰æ¡†çŠ¶æ€
                document.getElementById(`cdn-${recordId}`).checked = !enabled;
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡æ·»åŠ æ¨¡æ€æ¡†
        function showBatchAddModal() {
            document.getElementById('batchAddModal').style.display = 'block';
        }

        // æ‰¹é‡æ·»åŠ è®°å½•
        async function batchAddRecords() {
            const batchText = document.getElementById('batchRecords').value.trim();
            if (!batchText) {
                showStatus('è¯·è¾“å…¥æ‰¹é‡è®°å½•æ•°æ®', 'error');
                return;
            }

            const lines = batchText.split('\n').filter(line => line.trim());
            let successCount = 0;
            let errorCount = 0;

            for (const line of lines) {
                try {
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length < 3) continue;

                    const [type, name, content, ttl = '3600', proxied = 'false'] = parts;
                    
                    const recordData = {
                        type: type.toUpperCase(),
                        name: name === '@' ? currentZoneName : name,
                        content: content.replace(/"/g, ''),
                        ttl: parseInt(ttl),
                        proxied: proxied.toLowerCase() === 'true'
                    };

                    await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records`, 'POST', recordData);
                    successCount++;
                } catch (error) {
                    errorCount++;
                    console.error(`æ·»åŠ è®°å½•å¤±è´¥: ${line}`, error);
                }
            }

            showStatus(`æ‰¹é‡æ·»åŠ å®Œæˆ: æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${errorCount} æ¡`, 
                      errorCount > 0 ? 'warning' : 'success');
            
            closeModal('batchAddModal');
            await loadDNSRecords();
        }

        // æ˜¾ç¤ºæ‰¹é‡æ“ä½œæ¨¡æ€æ¡†
        function showBatchOperationModal() {
            document.getElementById('batchOperationModal').style.display = 'block';
        }

        // æ‰¹é‡åˆ‡æ¢ CDN
        async function batchToggleCDN(enabled) {
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showStatus('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„è®°å½•', 'error');
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const checkbox of checkedBoxes) {
                try {
                    const recordId = checkbox.dataset.recordId;
                    const record = allRecords.find(r => r.id === recordId);
                    
                    const recordData = {
                        type: record.type,
                        name: record.name,
                        content: record.content,
                        ttl: record.ttl,
                        proxied: enabled
                    };

                    await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records/${recordId}`, 'PUT', recordData);
                    successCount++;
                } catch (error) {
                    errorCount++;
                }
            }

            showStatus(`æ‰¹é‡ CDN ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}å®Œæˆ: æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${errorCount} æ¡`, 
                      errorCount > 0 ? 'warning' : 'success');
            
            await loadDNSRecords();
        }

        // æ‰¹é‡åˆ é™¤è®°å½•
        async function batchDeleteRecords() {
            const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showStatus('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkedBoxes.length} æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const checkbox of checkedBoxes) {
                try {
                    const recordId = checkbox.dataset.recordId;
                    await makeCloudflareRequest(`/zones/${currentZoneId}/dns_records/${recordId}`, 'DELETE');
                    successCount++;
                } catch (error) {
                    errorCount++;
                }
            }

            showStatus(`æ‰¹é‡åˆ é™¤å®Œæˆ: æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${errorCount} æ¡`, 
                      errorCount > 0 ? 'warning' : 'success');
            
            await loadDNSRecords();
        }

        // æ‰¹é‡æ“ä½œæ¨¡æ€æ¡†ä¸­çš„å…¨é€‰åŠŸèƒ½
        function toggleSelectAllInModal() {
            const selectAll = document.getElementById('selectAllRecordsModal');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            // é‡ç½®æœ€åé€‰æ‹©çš„ç´¢å¼•
            lastSelectedIndex = -1;
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            if (!currentZoneName || allRecords.length === 0) {
                showStatus('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•', 'error');
                return;
            }

            // è·å–é€‰ä¸­çš„è®°å½•
            const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');
            const selectedRecordIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.recordId);
            
            let recordsToExport = allRecords;
            let exportType = 'å…¨éƒ¨';
            
            if (selectedRecordIds.length > 0) {
                recordsToExport = allRecords.filter(record => selectedRecordIds.includes(record.id));
                exportType = 'é€‰ä¸­';
            }

            const config = {
                zoneName: currentZoneName,
                exportDate: new Date().toISOString(),
                exportType: exportType,
                totalRecords: recordsToExport.length,
                records: recordsToExport.map(record => ({
                    type: record.type,
                    name: record.name.replace(`.${currentZoneName}`, '') || '@',
                    content: record.content,
                    ttl: record.ttl,
                    proxied: record.proxied
                }))
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = selectedRecordIds.length > 0 
                ? `${currentZoneName}_selected_${selectedRecordIds.length}_records.json`
                : `${currentZoneName}_all_records.json`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            const message = selectedRecordIds.length > 0 
                ? `å·²å¯¼å‡º ${selectedRecordIds.length} æ¡é€‰ä¸­è®°å½•: ${filename}`
                : `å·²å¯¼å‡ºå…¨éƒ¨ ${recordsToExport.length} æ¡è®°å½•: ${filename}`;
            showStatus(message, 'success');
        }

        // æ˜¾ç¤ºå¯¼å…¥æ¨¡æ€æ¡†
        function showImportModal() {
            // å¡«å……ç›®æ ‡åŸŸåé€‰é¡¹
            const targetZoneSelect = document.getElementById('targetZone');
            targetZoneSelect.innerHTML = '';
            
            document.querySelectorAll('.zone-item').forEach(item => {
                const zoneName = item.querySelector('strong').textContent;
                const option = document.createElement('option');
                option.value = zoneName;
                option.textContent = zoneName;
                
                // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„åŸŸåï¼Œè®¾ä¸ºé»˜è®¤é€‰ä¸­
                if (zoneName === currentZoneName) {
                    option.selected = true;
                }
                
                targetZoneSelect.appendChild(option);
            });

            document.getElementById('importModal').style.display = 'block';
        }

        // å¯¼å…¥é…ç½®
        async function importConfig() {
            const fileInput = document.getElementById('importFile');
            const targetZone = document.getElementById('targetZone').value;
            const replaceExisting = document.getElementById('replaceExisting').checked;

            if (!fileInput.files[0]) {
                showStatus('è¯·é€‰æ‹©é…ç½®æ–‡ä»¶', 'error');
                return;
            }

            if (!targetZone) {
                showStatus('è¯·é€‰æ‹©ç›®æ ‡åŸŸå', 'error');
                return;
            }

            try {
                const fileContent = await fileInput.files[0].text();
                const config = JSON.parse(fileContent);

                if (!config.records || !Array.isArray(config.records)) {
                    throw new Error('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }

                // æ‰¾åˆ°ç›®æ ‡åŸŸåçš„ zone ID
                const targetZoneId = await getZoneIdByName(targetZone);
                if (!targetZoneId) {
                    throw new Error('æ‰¾ä¸åˆ°ç›®æ ‡åŸŸå');
                }

                // å¦‚æœé€‰æ‹©æ›¿æ¢ç°æœ‰è®°å½•ï¼Œå…ˆåˆ é™¤æ‰€æœ‰è®°å½•
                if (replaceExisting) {
                    const existingRecords = await makeCloudflareRequest(`/zones/${targetZoneId}/dns_records`);
                    for (const record of existingRecords.result) {
                        try {
                            await makeCloudflareRequest(`/zones/${targetZoneId}/dns_records/${record.id}`, 'DELETE');
                        } catch (error) {
                            console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
                        }
                    }
                }

                // å¯¼å…¥æ–°è®°å½•
                let successCount = 0;
                let errorCount = 0;

                for (const record of config.records) {
                    try {
                        const recordData = {
                            type: record.type,
                            name: record.name === '@' ? targetZone : record.name,
                            content: record.content,
                            ttl: record.ttl,
                            proxied: record.proxied
                        };

                        await makeCloudflareRequest(`/zones/${targetZoneId}/dns_records`, 'POST', recordData);
                        successCount++;
                    } catch (error) {
                        errorCount++;
                        console.error('å¯¼å…¥è®°å½•å¤±è´¥:', record, error);
                    }
                }

                showStatus(`å¯¼å…¥å®Œæˆ: æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${errorCount} æ¡`, 
                          errorCount > 0 ? 'warning' : 'success');
                
                closeModal('importModal');
                
                // å¦‚æœå¯¼å…¥åˆ°å½“å‰é€‰ä¸­çš„åŸŸåï¼Œåˆ·æ–°è®°å½•
                if (targetZone === currentZoneName) {
                    await loadDNSRecords();
                }

            } catch (error) {
                showStatus(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error', true);
            }
        }

        // æ ¹æ®åŸŸåè·å– zone ID
        async function getZoneIdByName(zoneName) {
            try {
                const result = await makeCloudflareRequest('/zones');
                const zone = result.result.find(z => z.name === zoneName);
                return zone ? zone.id : null;
            } catch (error) {
                return null;
            }
        }

        // åˆ·æ–°è®°å½•
        async function refreshRecords() {
            if (currentZoneId) {
                await loadDNSRecords();
                showStatus('è®°å½•å·²åˆ·æ–°', 'success');
            }
        }

        // æ¸…ç©ºè®°å½•è¡¨å•
        function clearRecordForm() {
            document.getElementById('recordType').value = 'A';
            document.getElementById('recordName').value = '';
            document.getElementById('recordValue').value = '';
            document.getElementById('recordTTL').value = '3600';
            document.getElementById('recordProxied').checked = false;
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // æ˜¾ç¤ºä»£ç†è®¾ç½®æ¨¡æ€æ¡†
        function showProxyModal() {
            loadProxySettings();
            document.getElementById('enableProxy').checked = proxySettings.enabled;
            document.getElementById('proxyType').value = proxySettings.type;
            document.getElementById('proxyHost').value = proxySettings.host;
            document.getElementById('proxyPort').value = proxySettings.port;
            document.getElementById('proxyUsername').value = proxySettings.username;
            document.getElementById('proxyPassword').value = proxySettings.password;
            
            toggleProxySettings();
            document.getElementById('proxyModal').style.display = 'block';
        }

        // åˆ‡æ¢ä»£ç†è®¾ç½®æ˜¾ç¤º
        function toggleProxySettings() {
            const enabled = document.getElementById('enableProxy').checked;
            document.getElementById('proxySettings').style.display = enabled ? 'block' : 'none';
        }

        // ä¿å­˜ä»£ç†è®¾ç½®
        function saveProxySettings() {
            proxySettings.enabled = document.getElementById('enableProxy').checked;
            proxySettings.type = document.getElementById('proxyType').value;
            proxySettings.host = document.getElementById('proxyHost').value;
            proxySettings.port = document.getElementById('proxyPort').value;
            proxySettings.username = document.getElementById('proxyUsername').value;
            proxySettings.password = document.getElementById('proxyPassword').value;
            
            saveProxySettingsToStorage();
            showStatus('ä»£ç†è®¾ç½®å·²ä¿å­˜', 'success');
            closeModal('proxyModal');
        }

        // æµ‹è¯•ä»£ç†è¿æ¥
        async function testProxyConnection() {
            console.log('testProxyConnection å‡½æ•°è¢«è°ƒç”¨');
            
            // æ‰¾åˆ°æ­£ç¡®çš„æŒ‰é’®
            const button = event ? event.target : document.querySelector('.btn-info');
            if (!button) {
                console.error('æ‰¾ä¸åˆ°ä»£ç†æµ‹è¯•æŒ‰é’®');
                showStatus('ç³»ç»Ÿé”™è¯¯ï¼šæ‰¾ä¸åˆ°æŒ‰é’®å…ƒç´ ', 'error');
                return;
            }
            
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="loading"></span> æµ‹è¯•ä¸­...';
            button.disabled = true;

            try {
                // è¿™é‡Œåªèƒ½æµ‹è¯•åŸºæœ¬è¿é€šæ€§ï¼Œå®é™…ä»£ç†åŠŸèƒ½éœ€è¦æµè§ˆå™¨æ‰©å±•æˆ–æ¡Œé¢åº”ç”¨æ”¯æŒ
                const testUrl = 'https://api.cloudflare.com/client/v4/user';
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'X-Auth-Email': document.getElementById('email').value || 'test@example.com',
                        'X-Auth-Key': document.getElementById('apiToken').value || 'test-token'
                    }
                });
                
                if (response.status === 401 || response.status === 403) {
                    showStatus('ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œä½† API å‡­æ®æ— æ•ˆ', 'warning');
                } else if (response.ok) {
                    showStatus('è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                } else {
                    showStatus(`è¿æ¥æµ‹è¯•å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // æµ‹è¯• API è¿æ¥
        async function testConnection() {
            console.log('testConnection å‡½æ•°è¢«è°ƒç”¨');
            
            // æ‰¾åˆ°æ­£ç¡®çš„æŒ‰é’®
            const button = event ? event.target : document.querySelector('.btn-warning');
            const originalText = button.innerHTML;
            
            console.log('æŒ‰é’®æ‰¾åˆ°:', button);
            
            button.innerHTML = '<span class="loading"></span> æµ‹è¯•ä¸­...';
            button.disabled = true;

            try {
                console.log('å¼€å§‹ API è¯·æ±‚');
                const result = await makeCloudflareRequest('/user');
                console.log('API è¯·æ±‚ç»“æœ:', result);
                
                if (result.success) {
                    const user = result.result;
                    showStatus(`è¿æ¥æˆåŠŸï¼ç”¨æˆ·: ${user.email}`, 'success');
                } else {
                    showStatus('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®', 'error', true);
                }
            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•é”™è¯¯:', error);
                showStatus(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error', true);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // æ˜¾ç¤º CORS è­¦å‘Š
        function showCorsWarning() {
            document.getElementById('corsWarning').style.display = 'block';
            // æ»šåŠ¨åˆ°è­¦å‘ŠåŒºåŸŸ
            document.getElementById('corsWarning').scrollIntoView({ behavior: 'smooth' });
        }

        // éšè— CORS è­¦å‘Š
        function hideCorsWarning() {
            document.getElementById('corsWarning').style.display = 'none';
        }

        // æµ‹è¯• CORS æ˜¯å¦å·²ä¿®å¤
        async function testCorsFixed() {
            hideCorsWarning();
            await testConnection();
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        // å¯åŠ¨ä»£ç†æœåŠ¡å™¨ï¼ˆæ¨¡æ‹Ÿï¼‰
        function startProxyServer() {
            const statusDiv = document.getElementById('proxyServerStatus');
            statusDiv.innerHTML = '<span style="color: #ffd700;">âš ï¸ æ³¨æ„ï¼šæµè§ˆå™¨ç¯å¢ƒæ— æ³•ç›´æ¥å¯åŠ¨æœåŠ¡å™¨</span><br>';
            statusDiv.innerHTML += '<span style="font-size: 12px;">å»ºè®®ä½¿ç”¨æ–¹æ¡ˆä¸€æˆ–æ–¹æ¡ˆäºŒè§£å†³ CORS é—®é¢˜</span>';
            
            // æä¾› Node.js ä»£ç†æœåŠ¡å™¨ä»£ç 
            setTimeout(() => {
                statusDiv.innerHTML += '<br><br><strong>å¯é€‰ï¼šåˆ›å»º Node.js ä»£ç†æœåŠ¡å™¨</strong><br>';
                statusDiv.innerHTML += '<button class="btn" style="background: rgba(255,255,255,0.2); font-size: 11px; padding: 4px 8px;" onclick="showProxyServerCode()">æŸ¥çœ‹ä»£ç†æœåŠ¡å™¨ä»£ç </button>';
            }, 1000);
        }

        // æ˜¾ç¤ºä»£ç†æœåŠ¡å™¨ä»£ç 
        function showProxyServerCode() {
            const code = `// proxy-server.js
const express = require('express');
const { createProxyMiddleware } = require('http-proxy-middleware');
const cors = require('cors');

const app = express();
app.use(cors());

app.use('/api', createProxyMiddleware({
    target: 'https://api.cloudflare.com',
    changeOrigin: true,
    pathRewrite: {
        '^/api': '/client/v4'
    }
}));

app.listen(3001, () => {
    console.log('ä»£ç†æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:3001');
});

// å®‰è£…ä¾èµ–: npm install express http-proxy-middleware cors
// è¿è¡Œ: node proxy-server.js`;
            
            const blob = new Blob([code], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'proxy-server.js';
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('ä»£ç†æœåŠ¡å™¨ä»£ç å·²ä¸‹è½½', 'success');
        }

        // æµ‹è¯•çŠ¶æ€æ˜¾ç¤ºåŠŸèƒ½
        function testStatusDisplay() {
            console.log('æµ‹è¯•çŠ¶æ€æ˜¾ç¤ºåŠŸèƒ½');
            showStatus('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜çŠ¶æ€æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚', 'success');
        }

        // åˆ‡æ¢è¿æ¥æ¨¡å¼
        function switchConnectionMode() {
            const useProxy = document.getElementById('proxyMode').checked;
            const proxyUrlInput = document.getElementById('proxyUrl');
            
            if (useProxy) {
                proxyUrlInput.style.display = 'block';
                localStorage.setItem('cf_dns_use_proxy', 'true');
                localStorage.setItem('cf_dns_proxy_url', proxyUrlInput.value);
                showStatus('å·²åˆ‡æ¢åˆ°ä»£ç†æ¨¡å¼', 'success');
            } else {
                proxyUrlInput.style.display = 'none';
                localStorage.setItem('cf_dns_use_proxy', 'false');
                showStatus('å·²åˆ‡æ¢åˆ°ç›´æ¥è¿æ¥æ¨¡å¼', 'info');
            }
        }

        // åŠ è½½è¿æ¥æ¨¡å¼è®¾ç½®
        function loadConnectionMode() {
            const useProxy = localStorage.getItem('cf_dns_use_proxy') === 'true';
            const proxyUrl = localStorage.getItem('cf_dns_proxy_url') || 'http://localhost:3001/api';
            
            if (useProxy) {
                document.getElementById('proxyMode').checked = true;
                document.getElementById('proxyUrl').style.display = 'block';
                document.getElementById('proxyUrl').value = proxyUrl;
            } else {
                document.getElementById('directMode').checked = true;
                document.getElementById('proxyUrl').style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            loadProxySettings();
            loadConnectionMode();
            
            // æµ‹è¯•çŠ¶æ€æ¶ˆæ¯åŒºåŸŸæ˜¯å¦å­˜åœ¨
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                console.log('statusMessage å…ƒç´ æ‰¾åˆ°');
            } else {
                console.error('statusMessage å…ƒç´ æœªæ‰¾åˆ°');
            }
        });

        // æœç´¢å’Œç­›é€‰åŠŸèƒ½
        function filterRecords() {
            const searchTerm = document.getElementById('searchRecords').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const proxyFilter = document.getElementById('proxyFilter').value;

            filteredRecords = allRecords.filter(record => {
                // æœç´¢ç­›é€‰
                const matchesSearch = !searchTerm || 
                    record.name.toLowerCase().includes(searchTerm) ||
                    record.content.toLowerCase().includes(searchTerm) ||
                    record.type.toLowerCase().includes(searchTerm);

                // ç±»å‹ç­›é€‰
                const matchesType = !typeFilter || record.type === typeFilter;

                // CDN çŠ¶æ€ç­›é€‰
                const matchesProxy = !proxyFilter || 
                    (proxyFilter === 'true' && record.proxied) ||
                    (proxyFilter === 'false' && !record.proxied);

                return matchesSearch && matchesType && matchesProxy;
            });

            renderDNSRecords();
            updateFilteredStats();
        }

        // æ¸…é™¤ç­›é€‰
        function clearFilters() {
            document.getElementById('searchRecords').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('proxyFilter').value = '';
            filteredRecords = [];
            renderDNSRecords();
            updateStats();
        }

        // æ›´æ–°ç­›é€‰åçš„ç»Ÿè®¡ä¿¡æ¯
        function updateFilteredStats() {
            const recordsToShow = filteredRecords.length > 0 ? filteredRecords : allRecords;
            const stats = {
                total: recordsToShow.length,
                proxied: recordsToShow.filter(r => r.proxied).length,
                types: {}
            };

            recordsToShow.forEach(record => {
                stats.types[record.type] = (stats.types[record.type] || 0) + 1;
            });

            const statsGrid = document.getElementById('statsGrid');
            const filterInfo = filteredRecords.length > 0 ? ` (ç­›é€‰å)` : '';
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">è®°å½•æ•°${filterInfo}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.proxied}</div>
                    <div class="stat-label">CDN å¯ç”¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Object.keys(stats.types).length}</div>
                    <div class="stat-label">è®°å½•ç±»å‹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.types.A || 0}</div>
                    <div class="stat-label">A è®°å½•</div>
                </div>
            `;
        }

        // åˆ‡æ¢è®°å½•è¯¦ç»†ä¿¡æ¯æ˜¾ç¤º
        function toggleRecordDetails(recordId) {
            const recordItem = document.querySelector(`[data-record-id="${recordId}"]`).closest('.record-item');
            const detailsDiv = document.getElementById(`details-${recordId}`);
            
            if (recordItem.classList.contains('expanded')) {
                // æ”¶èµ·
                recordItem.classList.remove('expanded');
                detailsDiv.classList.remove('expanded');
                detailsDiv.style.display = 'none';
            } else {
                // å±•å¼€
                recordItem.classList.add('expanded');
                detailsDiv.style.display = 'block';
                detailsDiv.classList.add('expanded');
            }
        }

        // å±•å¼€æ‰€æœ‰è®°å½•è¯¦æƒ…
        function expandAllRecords() {
            document.querySelectorAll('.record-item').forEach(item => {
                const recordId = item.dataset.recordId;
                const detailsDiv = document.getElementById(`details-${recordId}`);
                
                item.classList.add('expanded');
                detailsDiv.style.display = 'block';
                detailsDiv.classList.add('expanded');
            });
        }

        // æ”¶èµ·æ‰€æœ‰è®°å½•è¯¦æƒ…
        function collapseAllRecords() {
            document.querySelectorAll('.record-item').forEach(item => {
                const recordId = item.dataset.recordId;
                const detailsDiv = document.getElementById(`details-${recordId}`);
                
                item.classList.remove('expanded');
                detailsDiv.classList.remove('expanded');
                detailsDiv.style.display = 'none';
            });
        }

        // å¤„ç†å¤é€‰æ¡†å˜åŒ–ï¼Œæ”¯æŒ Shift æ‰¹é‡é€‰æ‹©
        function handleCheckboxChange(event, currentIndex) {
            const checkbox = event.target;
            const isShiftPressed = event.shiftKey;
            
            if (isShiftPressed && lastSelectedIndex !== -1 && lastSelectedIndex !== currentIndex) {
                // å¦‚æœæŒ‰ä½ Shiftï¼Œä»ç¬¬ä¸€ä¸ªé€‰ä¸­çš„åˆ°å½“å‰ç‚¹å‡»çš„éƒ½è¦è¢«é€‰ä¸­
                const startIndex = Math.min(lastSelectedIndex, currentIndex);
                const endIndex = Math.max(lastSelectedIndex, currentIndex);
                
                // æ‰¹é‡é€‰ä¸­ä» startIndex åˆ° endIndex çš„æ‰€æœ‰è®°å½•
                for (let i = startIndex; i <= endIndex; i++) {
                    const targetCheckbox = document.querySelector(`[data-record-index="${i}"]`);
                    if (targetCheckbox) {
                        targetCheckbox.checked = true; // å¼ºåˆ¶é€‰ä¸­
                    }
                }
            }
            
            // æ›´æ–°æœ€åé€‰æ‹©çš„ç´¢å¼•ï¼ˆåªæœ‰åœ¨é€‰ä¸­æ—¶æ‰æ›´æ–°ï¼‰
            if (checkbox.checked || !isShiftPressed) {
                lastSelectedIndex = currentIndex;
            }
        }

        // å¤åˆ¶è®°å½•åŠŸèƒ½
        function copyRecord(recordId) {
            const record = allRecords.find(r => r.id === recordId);
            if (!record) {
                showStatus('æ‰¾ä¸åˆ°è¦å¤åˆ¶çš„è®°å½•', 'error');
                return;
            }
            
            // æ¸…ç©ºç¼–è¾‘çŠ¶æ€
            editingRecordId = null;
            document.getElementById('modalTitle').textContent = 'å¤åˆ¶ DNS è®°å½•';
            
            // å¡«å……è¡¨å•ï¼Œä½†æ¸…ç©ºè®°å½•åç§°
            document.getElementById('recordType').value = record.type;
            document.getElementById('recordName').value = ''; // è®°å½•åç§°ç•™ç©º
            document.getElementById('recordValue').value = record.content;
            document.getElementById('recordTTL').value = record.ttl;
            document.getElementById('recordProxied').checked = record.proxied;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('recordModal').style.display = 'block';
            
            // è‡ªåŠ¨èšç„¦åˆ°è®°å½•åç§°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('recordName').focus();
            }, 100);
            
            showStatus(`å·²å¤åˆ¶è®°å½•ä¿¡æ¯ï¼Œè¯·è¾“å…¥æ–°çš„è®°å½•åç§°`, 'info');
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰åŠŸèƒ½
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllRecords');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            // é‡ç½®æœ€åé€‰æ‹©çš„ç´¢å¼•
            lastSelectedIndex = -1;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>

# Cloudflare DNS ç®¡ç†å·¥å…· Docker é•œåƒ
FROM node:18-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    curl \
    bash \
    && rm -rf /var/cache/apk/*

# å¤åˆ¶ package.json
COPY package.json ./

# é…ç½® npm ä»¥é¿å…æƒé™é—®é¢˜
RUN npm config set cache /app/.npm-cache && \
    npm config set prefix /app/.npm-global && \
    npm config set fund false && \
    npm config set audit false && \
    npm config set update-notifier false

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p .npm-cache .npm-global

# å®‰è£…ä¾èµ– - å¤šç§æ–¹æ¡ˆç¡®ä¿æˆåŠŸ
RUN npm install --no-optional --production || \
    npm install --unsafe-perm=true --no-optional --production || \
    (mkdir -p node_modules && echo '{"name": "minimal", "version": "1.0.0"}' > node_modules/package.json)

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY cf-dns-proxy-server.js ./
COPY cf_dns_manager.html ./
COPY test-server.js ./
COPY README.md ./

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# è®¾ç½®æ–‡ä»¶æƒé™
RUN chown -R nodejs:nodejs /app

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'echo "ğŸŒ å¯åŠ¨ Cloudflare DNS ç®¡ç†å·¥å…·..."' >> /app/start.sh && \
    echo 'echo "æ£€æŸ¥åº”ç”¨æ–‡ä»¶..."' >> /app/start.sh && \
    echo 'if [ ! -f "cf-dns-proxy-server.js" ]; then' >> /app/start.sh && \
    echo '  echo "âŒ åº”ç”¨æ–‡ä»¶ä¸å­˜åœ¨"' >> /app/start.sh && \
    echo '  exit 1' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo 'echo "æ£€æŸ¥ä¾èµ–..."' >> /app/start.sh && \
    echo 'if [ ! -d "node_modules" ]; then' >> /app/start.sh && \
    echo '  echo "âš ï¸  ä¾èµ–ç¼ºå¤±ï¼Œå°è¯•é‡æ–°å®‰è£…..."' >> /app/start.sh && \
    echo '  npm install --no-optional --production || true' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo 'echo "å¯åŠ¨æœåŠ¡å™¨..."' >> /app/start.sh && \
    echo 'if node -c cf-dns-proxy-server.js 2>/dev/null; then' >> /app/start.sh && \
    echo '  echo "âœ… å¯åŠ¨å®Œæ•´æœåŠ¡å™¨"' >> /app/start.sh && \
    echo '  exec node cf-dns-proxy-server.js' >> /app/start.sh && \
    echo 'else' >> /app/start.sh && \
    echo '  echo "âš ï¸  å®Œæ•´æœåŠ¡å™¨å¯åŠ¨å¤±è´¥ï¼Œä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨"' >> /app/start.sh && \
    echo '  exec node test-server.js' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    chmod +x /app/start.sh

USER nodejs

# æš´éœ²ç«¯å£
EXPOSE 3001

# å¥åº·æ£€æŸ¥ - æ›´å®½æ¾çš„æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=5 \
    CMD curl -f http://localhost:3001/health || curl -f http://localhost:3001/ || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["bash", "/app/start.sh"]
